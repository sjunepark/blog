---
id: 2
title: "Accessing environment variables in Astro deployed in Cloudflare"
description: "If you don't understand the various rendering modes in Astro, and also how the cloudflare environment works, it can be difficult to use environment variables"
pubDate: "2024-04-02"
updatedDate: "2024-04-02"
tags:
  - astro
  - cloudflare
  - environment-variables
  - deployment
published: false
---

## Why Cloudflare?

Cloudflare is a great platform for deploying static sites. It comes with a lot of built-in features related to
performance, security, image optimization, etc. But most importantly, it has a very generous free tier, is also very
cheap even when you go beyond the free tier.

## Astro rendering modes

The [Astro official docs](https://docs.astro.build/en/basics/rendering-modes/) has a great explanation but put in short,
by default Astro pre-renders all the pages at build time, meaning that page renders only happen during the initial
build. And all the pre-rendered pages will be served as simple files(html, css, js) without any processing during user
requests.

Pre-rendering is the default behavior, but you can opt out of this behavior as you wish for specific pages or routes.
This is called on-demand rendering, meaning that the page will be rendered at the point of time when the user requests.

> So, how does Cloudflare serve an Astro site for each rendering mode?

## Astro With Cloudflare

When deploying sites to Cloudflare, you can use [Cloudflare Pages](https://developers.cloudflare.com/pages/)
and [Cloudflare Workers](https://developers.cloudflare.com/workers/). Cloudflare Pages are for serving static sites for
default, meaning that you have to use Cloudflare Workers if you need on-demand rendering.

However, adapters like [@astrojs/cloudflare](https://docs.astro.build/en/guides/integrations-guide/cloudflare/)
automatically gathers routes(or pages) that need on-demand rendering, and put them in Cloudflare Workers for you. You
don't have to write any Cloudflare Worker specific cod by yourself.

| Rendering Mode | Cloudflare Pages | Cloudflare Workers |
|----------------|------------------|--------------------|
| Pre-rendering  | Yes              | No                 |
| On-demand      | No               | Yes                |

## Environment Variables

Now that we understand Astro's rendering modes and how Cloudflare serves them, let's talk about environment variables.

There are 3 environments(There's also the preview environment if you configure one, but for simplicity, it won't be
discussed in this post.)

1. Development
2. Production - Build
3. Production - Worker

The 1.Development environment is the most naive and error free environment, since you have access to all environment
variables.

The 2.Production - Build environment is when your application is built in the cloudflare server. This is where the *
*pre-rendered** Astro pages are built.

The 3.Production - Worker environment is where the *on-demand* Astro pages are built. These are not built at

In all environments, you can access
vite's [built-in variables](https://vitejs.dev/guide/env-and-mode#env-variables), such as `import.meta.env.DEV`, etc.
You can access your custom environment variables the same way during development(normally using `.env`), but it
production vite cannot access environment variables provided by Cloudflare. In order to understand this, you have to
know how Cloudflare injects environment variables.

**How environment variables are provided in each environment**

| Environment | `import.meta.env` | `context.locals.runtime`       |
|-------------|-------------------|--------------------------------|
| Development | `.env`            | `wrangler.toml` or `.dev.vars` |
| Build       | Cloudflare        | N/A                            |
| Worker      | N/A               | Cloudflare                     |

Cloudflare doesn't provide a way to inject environment variables directly to the Vite build process. This means  

